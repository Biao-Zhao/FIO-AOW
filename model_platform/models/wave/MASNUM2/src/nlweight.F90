 SUBROUTINE NLWEIGHT
 USE data_kind_mod_wave
 USE CONST_WAVE,ONLY: DELTTH,PI,G,JL,JLP1,PWK,KL,KLP1
 USE ALL_VAR_WAVE, ONLY: CONG,JP1,JP2,JM1,JM2,WK,WKS17,IKP,IKP1,  &
                    WP,WM,IKM,IKM1,AL11,AL21,AL31,AL13,AL23
 IMPLICIT NONE
 INTEGER(kind_in) JAFU 
 INTEGER(kind_in) IC,ICL1,ICL2,MR,J,JS,J1,J2,IS1,IKN,K
 REAL(kind_r4) :: CL1,CL2,CH,ACL1,ACL2,CL11,CL21,WKK
! REAL(kind_r4) :: AL11,AL21,AL31,AL12,AL22,AL13,AL23
 REAL(kind_r4) :: AL12,AL22
 REAL(kind_r4) :: ALOG10PWK,WKLP,WKLM,WKP,WKP1,WKLAP,WKLAP1
 REAL(kind_r4) :: WKLAM,WKLAM1,WKM,WKM1 
!!	 1. SETTING INITIAL VALUE 
 REAL(kind_r4),PARAMETER :: ALAMD = 0.25 
 REAL(kind_r4),PARAMETER :: CON = 7.862532087
 REAL(kind_r4),PARAMETER :: DELTHA = DELTTH*180/PI
 REAL(kind_r4),PARAMETER :: DELPHI = -11.48
 REAL(kind_r4),PARAMETER :: DELPHI2 = 33.56

 CONG = CON*SQRT(G)
!! 2.	COMPUTATION OF WEIGHTS F ANGULAR GRID

 CL1=DELPHI/DELTHA
! CL1=-0.3826667
 CL2=DELPHI2/DELTHA
 
 
 IC=1
 DO MR=1,2
 DO J=1,JL
    JS=J
    CH=IC*CL1
    J1=JAFU(CH,JS,JLP1)
    IS1=1
    IF (CH.LT.0) IS1=-1
    J2=J1+IS1
    IF (J2>JL) J2=1
    IF (J2<1) J2=JL
    JP1(MR,J)=J1
    JP2(MR,J)=J2
    JS=J
    CH=IC*CL2
    J1=JAFU(CH,JS,JLP1)
    IS1=1
    IF (CH<0) IS1=-1
    J2=J1+IS1
    IF (J2>JL) J2=1
    IF (J2<1) J2=JL
    JM1(MR,J)=J1
    JM2(MR,J)=J2
 END DO
    IC=-1
 END DO

 
 ICL1=CL1
 CL1=CL1-ICL1
 ICL2=CL2
 CL2=CL2-ICL2
 ACL1=ABS(CL1)
 ACL2=ABS(CL2)
 CL11=1.-ACL1
 CL21=1.-ACL2
 AL11=1.+ALAMD
 AL21=1.-ALAMD
 AL31=AL11*AL21
 AL12=AL11**2
 AL22=AL21**2
 AL13=AL11**3
 AL23=AL21**3

!!  	 INDICES AND WEIGHTS F FRQUENCY GRID

 ALOG10PWK=ALOG10(PWK)
 DO K=1,KL
    WKK=WK(K)
    WKS17(K)=SQRT(WKK**17)
    WKLP=WKK*AL12
    WKLM=WKK*AL22
    IKN=ALOG10(AL12)/ALOG10PWK
    IKN=K+IKN
    IKP(K)=IKN
    WKP=WK(IKP(K))
    IKP1(K)=IKP(K)+1
    WKP1=WK(IKP1(K))
    WKLAP=(WKLP-WKP)/(WKP1-WKP)
    WKLAP1=1.-WKLAP
    IF(IKP(K)<=KL)GO TO 2104
    IKP(K)=KLP1
    IKP1(K)=KLP1
2104   CONTINUE
    WP(K,1,1)=WKLAP1*CL11
    WP(K,1,2)=WKLAP1*ACL1
    WP(K,2,1)=WKLAP*CL11
    WP(K,2,2)=WKLAP*ACL1
    IF(WK(1)<WKLM)GO TO 2103
    IKM(K)=1
    IKM1(K)=1
    WKLAM=0.
    WKLAM1=0.
    GO TO 2102
2103   CONTINUE
    IKN=ALOG10(AL22)/ALOG10PWK
    IKN=K+IKN-1
    IF(IKN.LT.1) IKN=1
    IKM(K)=IKN
    WKM=WK(IKM(K))
    IKM1(K)=IKM(K)+1
    WKM1=WK(IKM1(K))
    WKLAM=(WKLM-WKM)/(WKM1-WKM)
    WKLAM1=1.-WKLAM
2102   CONTINUE
    WM(K,1,1)=WKLAM1*CL21
    WM(K,1,2)=WKLAM1*ACL2
    WM(K,2,1)=WKLAM*CL21
    WM(K,2,2)=WKLAM*ACL2
 END DO

 RETURN
 END
!======================================================================
 INTEGER FUNCTION JAFU(CL,J,IAN)
 USE data_kind_mod_wave
 IMPLICIT NONE
 INTEGER(kind_in),INTENT(IN) :: J,IAN
 REAL(kind_r4),INTENT(IN) :: CL
 
 INTEGER(kind_in) :: IDPH,JA
!
 IDPH=CL
 JA=J+IDPH
 IF(JA<=0)JA=IAN+JA-1
 IF(JA>=IAN)JA=JA-IAN+1
 JAFU=JA
!
 RETURN
 END
